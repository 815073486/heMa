<!DOCTYPE html>
<html class="x-admin-sm">
    
    <head>
        <meta charset="UTF-8">
        <title>欢迎页面-X-admin2.2</title>
        <meta name="renderer" content="webkit">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<!--        <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />-->
        <link rel="stylesheet" href="./css/font.css">
        <link rel="stylesheet" href="./css/xadmin.css">
        <script type="text/javascript" src="./lib/layui/layui.js" charset="utf-8"></script>
        <script type="text/javascript" src="./js/xadmin.js"></script>
        <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
        <!--[if lt IE 9]>
            <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
            <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body>
        <div class="layui-fluid">
            <div class="layui-row">
                <form style="margin-left: 150px;margin-top: 20px" class="layui-form layui-form-pane" lay-filter="demo" id="demo">
                    <div class="layui-form-item">
                        <label class="layui-form-label">
                            <span class="x-red">*</span>商品名称</label>
                        <div class="layui-input-inline">
                            <input type="text"  name="commname" lay-verify="required" autocomplete="off" class="layui-input"></div>
                    </div>
                    <div class="layui-form-item">
                        <label  class="layui-form-label">
                            <span class="x-red">*</span>商家名称</label>
                        <div class="layui-input-inline select">
                            <select name="merchantid" id="merchant" lay-verify="required">
                                <option value=""></option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label  class="layui-form-label">
                            <span class="x-red">*</span>导航栏类别</label>
                        <div class="layui-input-inline select">
                            <select name="classifyid" id="xm" lay-verify="required" lay-filter="xmFilter">
                                <option value=""></option>
                            </select>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label  class="layui-form-label">
                            <span class="x-red">*</span>导航子类</label>
                        <div class="layui-input-inline">
                            <select id="shipping" name="fatherid" class="valid">
                                <option value=""></option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label  class="layui-form-label">
                            <span class="x-red">*</span>是否热卖</label>
                        <div class="layui-input-inline">
                            <input type="checkbox" name="rush" lay-verify="checkbox" autocomplete="off" class="layui-input"></div>
                        <div class="layui-form-mid layui-word-aux">
                            <span class="x-red">*</span></div>
                    </div>
                    <div class="layui-form-item" >
                        <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
                            <div id="uploadQRcode" class="layui-upload">
                                <button type="button" class="layui-btn" id="uploadQR">
                                    <i class="layui-icon"></i>商品图片<span style="color: red;font-size: 20px;">*</span>
                                </button>
                                <div class="layui-upload-list">
                                    <img id="qrshow" src="" alt="" class="layui-upload-img"
                                         style="height: 100px;width:100px;border:1px solid black;">
                                </div>
                                <div id="startDiv">
                                    <button type="button" class="layui-btn" id="startUploadQR">开始上传</button>
                                </div>
                                <div style="color: #c2c2c2;margin:10px 0;">温馨提示: 每次最多上传一张图片, 单张图片的大小不超过2MB</div>
                            </div>
                            <input type="text" name="commimg" id="qrInput" style="display: none;" lay-verify="required">
                        </blockquote>
                    </div>
                    <div class="layui-form-item">
                        <label  class="layui-form-label">
                            <span class="x-red">*</span>商品简介</label>
                        <div class="layui-input-inline select">
                            <textarea style="margin-left: 10px; width: 205px; height: 100px;" name="presentation"  lay-verify="required"></textarea>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label  class="layui-form-label">
                            <span class="x-red">*</span>商品参数</label>
                        <div class="layui-input-inline select">
                            <input type="text"  name="parameter" lay-verify="required" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label  class="layui-form-label">
                            <span class="x-red">*</span>商品价格</label>
                        <div class="layui-input-inline select">
                            <input type="text"  name="price" lay-verify="required" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label  class="layui-form-label">
                            <span class="x-red">*</span>商品库存</label>
                        <div class="layui-input-inline select">
                            <input type="text"  name="stocknum" lay-verify="required" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item" >
                        <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
                            <div id="uploadImg" class="layui-upload">
                                <button type="button" class="layui-btn" id="upload">
                                    <i class="layui-icon"></i>商品附图<span style="color: red;font-size: 20px;">*</span>
                                </button>
                                <div class="layui-upload-list">
                                    <table class="layui-table" style="text-align: center;">
                                        <thead>
                                        <tr>
                                            <th style="text-align: center;">图片预览</th>
                                            <th style="text-align: center;">大小</th>
                                            <th style="text-align: center;">状态</th>
                                            <th style="text-align: center;">操作</th>
                                        </tr>
                                        </thead>
                                        <tbody id="imgList1"></tbody>
                                    </table>
                                </div>
                                <button type="button" class="layui-btn" id="startUpload">开始上传</button>
                                <div style="color: #c2c2c2;margin:10px 0;">温馨提示: 每次最多上传六张图片, 单张图片的大小不超过5MB, 长宽比例推荐1.5:1,
                                    推荐上传图片长675px,宽450px
                                </div>
                            </div>
<!--                            <input type="text" name="img" id="imgInput" style="display: none;" lay-verify="required">-->
                        </blockquote>

                    </div>
                    <div class="layui-form-item" id="update">
                        <button class="layui-btn layui-btn-danger" lay-submit lay-filter="login" style="margin-left: 140px" type="submit">
                            <i class="layui-icon"></i>增加</button>
                    </div>
        </form>
        </div>
        </div>
        <script>
            //Demo
            layui.use(['form','upload'], function(){
                var form = layui.form;
                var upload=layui.upload;
                var $=layui.jquery;
                var demo='';
                //选完文件后不自动上传  商品主图
                var uploadSingle = upload.render({
                    elem: '#uploadQR'
                    , url: 'manager/uploadimg'
                    , accept: 'images'  // 允许上传的文件类型
                    , size: 2048        // 最大允许上传的文件大小  单位 KB
                    , auto: false
                    , bindAction: '#startUploadQR'
                    , choose: function (obj) {
                        //预读本地文件示例，不支持ie8
                        obj.preview(function (index, file, result) {
                            $('#qrshow').attr('src', result); //图片链接（base64）
                        });
                    }
                    , done: function (res, index, upload) {
                        if (res.code == 0) {
                            //上传成功
                            $("#qrInput").val(res.data.src);
                            var startDiv = $('#startDiv');
                            startDiv.html('<span style="color: #5FB878;">上传成功</span>');
                        } else {
                            this.error(index, upload);
                        }
                    }
                    , error: function (index, upload) {
                        //演示失败状态，并实现重传
                        var startDiv = $('#startDiv');
                        startDiv.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload" style="width:50px;height:30px;text-align:center;line-height:30px;">重试</a>');
                        startDiv.find('.demo-reload').on('click', function () {
                            uploadSingle.upload();
                        });
                    }
                });
                //拿来接收多张图的变量
                var valData = "";
                //多文件列表示例  附图
                var demoListView = $("#imgList1");
                var totalArray = new Array();
                var uploadInst = upload.render({
                    elem: '#upload' //绑定元素
                    , url: 'manager/uploadimg' //上传接口
                    , accept: 'images'  // 允许上传的文件类型
                    // , acceptMime: 'image/jpg,image/png'   // (只支持jpg和png格式，多个用逗号隔开),
                    , size: 5120        // 最大允许上传的文件大小  单位 KB
                    , auto: false //选择文件后不自动上传
                    , bindAction: '#startUpload' //指向一个按钮触发上传
                    , multiple: true   // 开启多文件上传
                    , number: 6    //  同时上传文件的最大个数
                    , choose: function (obj) {
                        var files = this.files = obj.pushFile(); //将每次选择的文件追加到文件队列
                        var arr = Object.keys(files);
                        totalArray = totalArray.concat(arr);
                        // 检查上传文件的个数
                        if (totalArray.length <= 6) {
                            //读取本地文件
                            obj.preview(function (index, file, result) {
                                var tr = $(['<tr id="upload-' + index + '">'
                                    , '<td><img src="' + result + '" alt="' + file.name + '" class="layui-upload-img" style="height: 66px;width:100px;"></td>'
                                    , '<td>' + (file.size / 1014).toFixed(1) + 'kb</td>'
                                    , '<td>等待上传</td>'
                                    , '<td>'
                                    , '<button class="layui-btn demo-reload layui-hide">重传</button>'
                                    , '<button class="layui-btn layui-btn-danger demo-delete">删除</button>'
                                    , '</td>'
                                    , '</tr>'].join(''));

                                //单个重传
                                tr.find('.demo-reload').on('click', function () {
                                    obj.upload(index, file);
                                });
                                //删除
                                tr.find('.demo-delete').on('click', function () {
                                    delete files[index]; //删除对应的文件
                                    tr.remove();
                                    uploadListIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
                                });
                                demoListView.append(tr);
                            });
                        } else {
                            // 超出上传最大文件
                            layer.msg("上传文件最大不超过6个")
                        }

                    }
                    , done: function (res, index, upload) {
                        console.log("res", res);
                        if (res.code == 0) { //上传成功
                            // 上传成功后将图片路径拼接到input中，多个路径用","分割
                            //var inputVal = document.getElementById("imgInput").value;
                            if (valData!="") {
                                valData = valData + "," + res.data.src;
                            } else {
                                valData = res.data.src;
                            }
                            //document.getElementById("imgInput").value = valData;
                            var tr = demoListView.find('tr#upload-' + index)
                                , tds = tr.children();
                            tds.eq(2).html('<span style="color: #5FB878;">上传成功</span>');
                            tds.eq(3).html(''); //清空操作
                            return delete this.files[index]; //删除文件队列已经上传成功的文件
                        }
                        this.error(index, upload);
                    }
                    , error: function (index, upload) {
                        var tr = demoListView.find('tr#upload-' + index)
                            , tds = tr.children();
                        tds.eq(2).html('<span style="color: #FF5722;">上传失败</span>');
                        tds.eq(3).find('.demo-reload').removeClass('layui-hide'); //显示重传
                    }
                });

                //监听提交
               form.on('submit(login)', function(data){
                    var s=$("form").serialize()+"&img="+valData;
                    $.ajax({
                        url:"consumer/savCommodity",
                        type:"post",
                        //contentType : "application/json",
                        data:s,
                        success:function (data) {
                            if(data==200){
                                layer.msg("商品添加成功！")
                                var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                                parent.layer.close(index);
                                parent.tablepage.reload();
                            }else if(data==0){
                                layer.msg("商品参数添加失败！")
                            }else if(data==2){
                                layer.msg("商品附图添加失败！")
                            }else{
                                layer.msg("商品添加失败！")
                            }
                        }
                    })
                    return false;
                });
            });
        </script>
        <script>
            layui.use(['form', 'upload', 'layer'], function () {
                    var form = layui.form;//检查项目添加到下拉框中
                    var $=layui.jquery;
                    $.ajax({
                        url: 'consumer/classifyfall',           //商品一级分类
                        dataType: 'json',
                        type: 'post',
                        success: function (data) {
                            $.each(data, function (index, item) {
                                $('#xm').append(new Option(item.classifyname, item.classifyid));// 下拉菜单里添加元素
                            });
                            layui.form.render("select");//重新渲染 固定写法
                        }
                    })
                    $.ajax({
                        url:"consumer/merchantfall",            //商家查询
                        dataType:'json',
                        type:'post',
                        success:function (data) {
                            $.each(data, function (index, item) {
                                $('#merchant').append(new Option(item.merchantname, item.merchantid));// 下拉菜单里添加元素
                            });
                            layui.form.render("select");//重新渲染 固定写法
                        }
                    })
                form.on('select(xmFilter)',function (data) {
                    var sex= data.value;                                   //获取value值
                    var text= data.elem[data.elem.selectedIndex].text;    //获取显示的值
                    $.ajax({
                        url:'consumer/classifyId?fatherid='+sex,            //二级分类
                        dataType: 'json',
                        type: 'post',
                        success: function (daa) {
                            $("#shipping").empty();
                            if(daa!=null){
                                $.each(daa, function (index, item) {
                                    $('#shipping').append(new Option(item.classifyname, item.classifyid));// 下拉菜单里添加元素
                                });
                            }else {
                                $.each(daa, function (index, item) {
                                    $('#shipping').append(new Option("请选择", ""));// 下拉菜单里添加元素
                                });
                            }
                            layui.form.render("select");//重新渲染 固定写法
                        }
                    })
                })
            });
        </script>
        <script>
            layui.use(['form','upload;','layer'],
            function() {
                $ = layui.jquery;
                var form = layui.form,
                layer = layui.layer;
                //自定义验证规则
                form.verify({
                    nikename: function(value) {
                        if (value.length < 5) {
                            return '昵称至少得5个字符啊';
                        }
                    },
                    pass: [/(.+){6,12}$/, '密码必须6到12位'],
                    repass: function(value) {
                        if ($('#L_pass').val() != $('#L_repass').val()) {
                            return '两次密码不一致';
                        }
                    }
                });
            });
        </script>
        <script>
            var _hmt = _hmt || []; (function() {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?b393d153aeb26b46e9431fabaf0f6190";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
            })();
        </script>
    </body>

</html>